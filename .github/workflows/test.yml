name: Tests
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  adapter-tests:
    name: Adapter Tests (Express, FastAPI, Caching, Security, Gateway)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install Express test deps
        run: cd testing/express-test && npm install
      - name: Install adapter deps
        run: cd adapters/express && npm install
      - name: Run Express tests
        run: node testing/test-express.js
      - name: Run Caching tests
        run: node testing/test-caching.js
      - name: Run Security tests
        run: node testing/test-security.js
      - name: Run Gateway Dialogue tests
        run: node testing/gateway-dialogue-test.js

  sidecar-tests:
    name: Sidecar Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: pip install httpx beautifulsoup4 lxml
      - name: Run chunker tests
        run: python3 sidecar/test_chunker.py
      - name: Run sidecar unit tests
        run: python3 sidecar/test_sidecar.py
        env:
          SIDECAR_URL: ""

  cms-tests:
    name: CMS Integration Tests (WordPress, Drupal, Joomla)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start CMS containers
        run: docker compose -f testing/docker-compose.yml up -d
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install validator deps
        run: cd validator && pip install -r requirements.txt
      - name: Wait for WordPress DB
        run: |
          timeout 60 bash -c 'until docker compose -f testing/docker-compose.yml exec -T wp-db mysqladmin ping -h localhost -uroot -prootpassword --silent; do sleep 2; done'
      - name: Install WordPress core
        run: |
          docker compose -f testing/docker-compose.yml run --rm wpcli core install \
            --url=http://localhost:8081 \
            --title="OpenFeeder Test" \
            --admin_user=admin \
            --admin_password=Admin1234! \
            --admin_email=test@example.com
      - name: Activate OpenFeeder plugin and configure permalinks
        run: |
          docker compose -f testing/docker-compose.yml run --rm wpcli plugin activate openfeeder
          docker compose -f testing/docker-compose.yml run --rm wpcli rewrite structure '/%postname%/'
          docker compose -f testing/docker-compose.yml run --rm wpcli rewrite flush
      - name: Wait for WordPress
        run: |
          timeout 60 bash -c 'until curl -sf http://localhost:8081/wp-json/ > /dev/null; do sleep 2; done'
      - name: Run WordPress validator
        run: python3 validator/validator.py http://localhost:8081
      - name: Wait for Drupal
        run: |
          timeout 120 bash -c 'until curl -sf http://localhost:8082/ > /dev/null; do sleep 3; done'
      - name: Run Drupal validator
        # Drupal requires full site install + module enable — best-effort in CI
        run: python3 validator/validator.py http://localhost:8082
        continue-on-error: true
      - name: Wait for Joomla
        run: |
          timeout 120 bash -c 'until curl -sf http://localhost:8083/ > /dev/null; do sleep 3; done'
      - name: Run Joomla validator
        # Joomla requires full site install + plugin config — best-effort in CI
        run: python3 validator/validator.py http://localhost:8083
        continue-on-error: true
      - name: Stop containers
        if: always()
        run: docker compose -f testing/docker-compose.yml down -v

  validator-tests:
    name: Validator Self-Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: cd validator && pip install -r requirements.txt
      - name: Test validator against live SketchyNews
        run: cd validator && python3 validator.py https://sketchynews.snaf.foo
        continue-on-error: true
